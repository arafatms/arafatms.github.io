---
layout: post
title: 【PCIe】一，PCI基础知识总结
date: 2022-6-17
tags: PCIe
---

内容均来自[转载http://blog.chinaaet.com/justlxy/p/5100057779](http://blog.chinaaet.com/justlxy/p/5100057779)以及笔者阅读PCI spec后的补充

# PCI架构综述
## 基于PCI总线的结构

<img src="/images/posts/20220727-PCIRelated/1_2.png" width="700px" />

该平台包含三级总线: FSB(Front-side-bus)、 PCI 和 ISA， FSB是处理器子系统的总线，原称为Host总线，总线 定义完全取决于系统所使用的处理器； PCI局部总线是一个完全与处理器无关的总线， 不受制于系统所使用的微处理器的种类； ISA总线亦称为IO扩展总线，在实际系统中， 也有采用EISA或MC总线的，以ISA总线用得较多。 不同的总线之间通过相应的桥芯 片来隔离和转接。

平台中两级桥是必须具有的，一是HOST到PCI的桥（常称为主桥-Host桥） ，即 图中的北桥；另一个是PCI到扩展IO总线的桥（常称为扩展总线桥), 即图中的南桥。

PCI总线是一种树型结构，并且独立于CPU总线，可以和CPU总线并行操作。PCI总线上可以挂接PCI设备和PCI桥，PCI总线上只允许有一个PCI主设备（同一时刻），其他的均为PCI 从设备，而且读写操作只能在主从设备之间进行，从设备之间的数据交换需要通过主设备中转。

> 注：这并不意味着所有的读写操作都需要通过北桥中转，因为PCI总线上的主设备和从设备属性是可以变化的。比如Ethernet和SCSI需要传输数据，可以通过一种叫做Peer-to-Peer的方式来完成，此时Ethernet或者SCSI则作为主机，其它的设备则为从机。具体会在后面的博文中详细介绍。

一个典型的33MHz的PCI总线系统如上图所示，处理器通过FSB与北桥相连接，北桥上挂载着图形加速器（显卡）、SDRAM（内存）和PCI总线。PCI总线上挂载着南桥、以太网、SCSI总线（一种老式的小型机总线）和若干个PCI插槽。CD和硬盘则通过IDE连接至南桥，音频设备以及打印机、鼠标和键盘等也连接至南桥，此外南桥还提供若干的USB接口。南桥上还挂有ISA总线,为慢速设备提供兼容接口，称之为SIO桥（System IO）。

PCI总线是一种共享总线，所以需要特定的仲裁器（Arbiter）来决定当前时刻的总线的控制权。一般该仲裁器位于北桥中，而仲裁器（主机）则通过一对引脚，REQ#（request） 和GNT# （grant）来与各个从机连接。

需要注意的是，并不是所有的设备都有能力成为仲裁器（Arbiter）或者initiator 。

最初的PCI总线的时钟频率为33MHz，但是随着版本的更新，时钟频率也逐渐的提高。但是由于PCI采用的是一种Reflected-Wave Signaling信号模型（后面会详细的介绍），导致了时钟频率越高，总线的最大负载越少，如下图所示：

<img src="/images/posts/20220727-PCIRelated/1_3.png" width="700px" />

## 一个典型的PCI总线周期

PCI总线是一种地址和数据复用的总线，即地址和数据占用同一组信号线AD。PCI总线的所有信号都与时钟信号同步，及所有的信号的变化都发生在时钟的上升沿，或者在时钟上升沿进行采样。

<img src="/images/posts/20220727-PCIRelated/1_4.png" width="700px" />

如下图所示，除了时钟信号CLK和数据地址复用信号AD之外，PCI总线至少还应包括FRAME#（用于表示一次数据传输的起始）、C/BE#（Command/Byte Enable）、IRDY#（Initiator Ready for data）、TRDY#（Target ready）、DESEL#（Device Selec，片选信号，用于选择PCI设备）和GNT#（Grant）信号等。

<img src="/images/posts/20220727-PCIRelated/1_5.png" width="700px" />

1.启动读事务的主设备肯定#FRAME信号表示开始一个总线事物，FRAME#被肯定后的第一个时钟是地址相。在地址相中，主设备在AD[31:0]上给出一个有效的地址，在C/BE[3:0]#上给出总线读命令编码。总线上所有的从设备采样到FRAME#为有效后都输入地址和命令，并进行仪码，仪码选中的目标肯定DEVSEL#表示认领该事务的访问，较慢的设备可能会推迟DEVSEL#信号发出的时间。地址相后只要保持FRAME#就表示该事务还在继续，当该事务已经处于最后一个数据相时，在IRDY#为肯定的情况下，主设备否认FRAME#。

2.地址相后是第一个数据相，读事务的地址相和第一个数据相之间，在AD[31:0]线上有一个周转周期，因为在地址相和第一个数据相里，AD[31:0]信号线分别由主设备和目标驱动，当中需要设置一个周转周期，由目标否定TRDY#来设置。

3.在各数据相期间，C/BE#为字节使能，指出在现行数据相中包含哪些字节通路。这些使能信息在对应数据相一开始的时候就有效了。在个数据相里，是在IRDY#和TRDY#均有效的时钟上升沿处进行主设备和目标间的数据传送，只要有一方未准备，就插入等待周期，数据传送之后就进入下一数据相。

4.主设备在最后一个数据相且IRDY#为肯定时，否定FRAME#, 向目标表明这是本 事务最后一个数据相.

## PCI总线的三种传输模式

来简单地介绍一下PCI Spec规定的三种数据传输模型：Programmed I/O（PIO），Peer-to-Peer和DMA。三种数据传输模型的示意图如下图所示：

<img src="/images/posts/20220727-PCIRelated/1_6.png" width="700px" />

### Programmed I/O（PIO）

PIO在早期的PC中被广泛使用，因外当时的处理器的速度要远远大于任何其他外设的速度，所以PIO足以胜任所有的任务。举一个例子，比如说某一个PCI设备需要向内存（SDRAM）中写入一些数据，该PCI设备会向CPU请求一个中断，然后CPU首先先通过PCI总线把该PCI设备的数据读取到CPU内部的寄存器中，然后再把数据从内部寄存器写入到内存（SDRAM）中。

现在看来，这种传输方式的效率还是很低的。首先，每次CPU和PCI设备以及SDRAM通信都需要额外的时钟周期（相对于DMA）；其次，这种传输方式还需要长时间地占用CPU，影响CPU的使用率。试想一下，你在用PC在线观看一个1080p60的高清视频，这需要以太网连续地向内存（SDRAM）中写入数据，如果使用PIO的方式的话，将难以保证数据的写入速度。随着目前的PCI外设速度越来越高，PIO已经逐渐被DMA传输方式所取代，但是为了兼容早期的一些设备，PCI Spec依然保留了PIO。

### Direct Memory Access(DMA)

DMA是一种在传输过程中，几乎不需要CPU进行干预的数据传输方式。如上面的图片所示，以太网可以直接向内存（SDRAM）中写入数据，而几乎不需要CPU的干预。实际上，DMA不仅仅应用于PCI总线系统中，它是一种更为广泛应用的数据传输方式。目前，几乎所有的CPU，甚至是MCU都支持DMA。具体这里就不详细地介绍了，有兴趣的可以参考百度百科：https://baike.baidu.com/item/DMA/2385376?fr=aladdin或者其它的资料。

### Peer-to-Peer

前面的文章中，我们介绍过PCI总线系统中的主机身份并不是固定不变的，而是可以切换的（借助仲裁器），但是同一时刻只能存在一个主机。完成Peer-to-Peer这一传输方式的前提是，PCI总线系统中至少存在一个有能力成为主机的设备。在仲裁器的控制下，完成主机身份的切换，进而获得PCI总线的控制权，然后与总线上的其他PCI设备进行通信。不过，需要注意的是，在实际的系统中，Peer-to-Peer这一传输方式却很少被使用，这是因为获得主机身份的PCI设备（Initiator）和另一个PCI设备（Target）通常采用不同的数据格式，除非他们是同一个厂家的设备。